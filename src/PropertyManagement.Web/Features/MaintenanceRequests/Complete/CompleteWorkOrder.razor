@page "/maintenance-requests/complete"
@using MediatR
@using MudBlazor
@using PropertyManagement.Web.Features.MaintenanceRequests.Complete
@using PropertyManagement.Web.Features.MaintenanceRequests.Complete.Models
@using Microsoft.EntityFrameworkCore
@using PropertyManagement.Web.Infrastructure.Persistence
@inject IMediator Mediator
@inject ISnackbar Snackbar
@inject PropertyManagementDbContext DbContext

<PageTitle>Complete Work Orders</PageTitle>

<MudContainer MaxWidth="MaxWidth.Large" Class="mt-8">
    <MudText Typo="Typo.h4" Class="mb-4">Complete Work Orders</MudText>

    <MudGrid>
        <!-- Assigned Work Orders Panel -->
        <MudItem xs="12" md="6">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-4">In-Progress Work Orders</MudText>

                @if (_isLoadingWorkOrders)
                {
                    <MudProgressCircular Indeterminate="true" Size="Size.Small" />
                }
                else if (_assignedWorkOrders.Any())
                {
                    <MudList T="string">
                        @foreach (var workOrder in _assignedWorkOrders)
                        {
                            <MudListItem T="string" OnClick="@(() => SelectWorkOrder(workOrder))"
                                         Class="@(_selectedWorkOrder?.Id == workOrder.Id ? "mud-theme-primary" : "")">
                                <MudText Typo="Typo.body1">
                                    <MudChip T="string" Color="@GetPriorityColor(workOrder.PriorityName)" Size="Size.Small">
                                        @workOrder.PriorityName
                                    </MudChip>
                                    @workOrder.Property?.Name
                                </MudText>
                                <MudText Typo="Typo.body2" Class="mt-1">
                                    @(workOrder.Description.Length > 60 ? workOrder.Description.Substring(0, 60) + "..." : workOrder.Description)
                                </MudText>
                                <MudText Typo="Typo.caption">
                                    Vendor: @workOrder.Vendor?.Name | Estimated: $@workOrder.EstimatedCostAmount.ToString("N2")
                                </MudText>
                            </MudListItem>
                            <MudDivider />
                        }
                    </MudList>
                }
                else
                {
                    <MudAlert Severity="Severity.Info">No work orders in progress</MudAlert>
                }
            </MudPaper>
        </MudItem>

        <!-- Completion Form Panel -->
        <MudItem xs="12" md="6">
            <MudPaper Elevation="2" Class="pa-4">
                <MudText Typo="Typo.h6" Class="mb-4">Mark as Completed</MudText>

                @if (_selectedWorkOrder == null)
                {
                    <MudAlert Severity="Severity.Info">
                        Select a work order from the left to mark it as completed
                    </MudAlert>
                }
                else
                {
                    <MudText Typo="Typo.subtitle2" Class="mb-2">Selected Work Order:</MudText>
                    <MudPaper Elevation="1" Class="pa-3 mb-4">
                        <MudText Typo="Typo.body1">
                            <strong>Property:</strong> @_selectedWorkOrder.Property?.Name
                        </MudText>
                        <MudText Typo="Typo.body2">
                            <strong>Description:</strong> @_selectedWorkOrder.Description
                        </MudText>
                        <MudText Typo="Typo.caption">
                            <strong>Vendor:</strong> @_selectedWorkOrder.Vendor?.Name
                        </MudText>
                        <MudText Typo="Typo.caption">
                            <strong>Estimated Cost:</strong> $@_selectedWorkOrder.EstimatedCostAmount.ToString("N2")
                        </MudText>
                    </MudPaper>

                    <MudForm @ref="_form" @bind-IsValid="@_isFormValid">
                        <MudTextField @bind-Value="@_completionNotes" Label="Completion Notes" Required="true"
                                      Lines="5" Variant="Variant.Outlined"
                                      Counter="2000" MaxLength="2000"
                                      HelperText="Describe what work was completed (minimum 10 characters)" />

                        <MudNumericField T="decimal" @bind-Value="@_actualCost" Label="Actual Cost" Required="true"
                                         Variant="Variant.Outlined" Min="0" Class="mt-4"
                                         HelperText="Enter the final cost of the work" />

                        @if (_actualCost > 0 && _selectedWorkOrder.EstimatedCostAmount > 0)
                        {
                            var difference = _actualCost - _selectedWorkOrder.EstimatedCostAmount;
                            var percentage = (difference / _selectedWorkOrder.EstimatedCostAmount) * 100;

                            @if (Math.Abs(percentage) > 20)
                            {
                                <MudAlert Severity="@(percentage > 0 ? Severity.Warning : Severity.Success)" Class="mt-2">
                                    Actual cost is @(percentage > 0 ? "over" : "under") estimate by $@Math.Abs(difference).ToString("N2") (@percentage.ToString("N1")%)
                                </MudAlert>
                            }
                        }

                        <MudButton Variant="Variant.Filled" Color="Color.Success" Class="mt-4"
                                   OnClick="@CompleteWorkOrderAsync"
                                   Disabled="@(!_isFormValid || _isCompleting)"
                                   FullWidth="true"
                                   StartIcon="@Icons.Material.Filled.CheckCircle">
                            @if (_isCompleting)
                            {
                                <MudProgressCircular Size="Size.Small" Indeterminate="true" />
                                <span class="ml-2">Completing...</span>
                            }
                            else
                            {
                                <span>Mark as Completed</span>
                            }
                        </MudButton>
                    </MudForm>
                }
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private MudForm? _form;
    private bool _isFormValid;

    private bool _isLoadingWorkOrders = true;
    private bool _isCompleting = false;

    private List<WorkOrder> _assignedWorkOrders = new();
    private WorkOrder? _selectedWorkOrder;

    private string _completionNotes = string.Empty;
    private decimal _actualCost = 0;

    protected override async Task OnInitializedAsync()
    {
        await LoadAssignedWorkOrders();
    }

    private async Task LoadAssignedWorkOrders()
    {
        try
        {
            _isLoadingWorkOrders = true;
            _assignedWorkOrders = await DbContext.Set<WorkOrder>()
                .Include(w => w.Property)
                .Include(w => w.Vendor)
                .Where(w => w.AssignedVendorId != null && w.Status == "Assigned")
                .OrderByDescending(w => w.PriorityLevel)
                .ThenBy(w => w.AssignedAt)
                .ToListAsync();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading work orders: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isLoadingWorkOrders = false;
        }
    }

    private void SelectWorkOrder(WorkOrder workOrder)
    {
        _selectedWorkOrder = workOrder;
        _completionNotes = string.Empty;
        _actualCost = workOrder.EstimatedCostAmount; // Default to estimated cost
        StateHasChanged();
    }

    private async Task CompleteWorkOrderAsync()
    {
        if (_selectedWorkOrder == null || !_isFormValid)
            return;

        // Validate minimum notes length
        if (_completionNotes.Length < 10)
        {
            Snackbar.Add("Completion notes must be at least 10 characters", Severity.Error);
            return;
        }

        try
        {
            _isCompleting = true;

            var command = new CompleteWorkOrderCommand
            {
                WorkOrderId = _selectedWorkOrder.Id,
                CompletionNotes = _completionNotes,
                ActualCost = _actualCost
            };

            var response = await Mediator.Send(command);

            if (response.Success)
            {
                Snackbar.Add("Work order marked as completed successfully!", Severity.Success);

                // Remove from list and reset selection
                _assignedWorkOrders.Remove(_selectedWorkOrder);
                _selectedWorkOrder = null;
                _completionNotes = string.Empty;
                _actualCost = 0;
            }
            else
            {
                var errorMessage = response.Errors.Any()
                    ? string.Join(", ", response.Errors)
                    : response.Message;
                Snackbar.Add(errorMessage, Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error completing work order: {ex.Message}", Severity.Error);
        }
        finally
        {
            _isCompleting = false;
        }
    }

    private Color GetPriorityColor(string priority)
    {
        return priority switch
        {
            "Emergency" => Color.Error,
            "High" => Color.Warning,
            "Medium" => Color.Info,
            _ => Color.Default
        };
    }
}
